<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Confirmação de Presença</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background: #0d0d0d;
      color: #eee;
      font-family: 'Poppins', sans-serif;
    }

    .card {
      background: #161616;
      border: 1px solid #2a2a2a;
      border-radius: 18px;
    }

    .input {
      background: #1f1f1f !important;
      border: 1px solid #333 !important;
      color: #eee !important;
      border-radius: 10px;
      font-size: 16px !important;
    }

    .input:focus {
      border-color: #888 !important;
      box-shadow: 0 0 0 2px rgba(0, 255, 0, 0.25);
    }

    .btn-primary {
      background: #00c851;
      color: #000;
      border-radius: 12px;
      font-weight: 700;
      transition: 0.3s;
      font-size: 16px !important;
    }

    .btn-primary:hover {
      background: #00e15d;
    }

    .fade {
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .modal-back {
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(3px);
    }

    .modal-box {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 18px;
      animation: popup 0.25s ease forwards;
      transform: scale(0.85);
      opacity: 0;
    }

    @keyframes popup {
      to { transform: scale(1); opacity: 1; }
    }

    .spinner {
      width: 65px;
      height: 65px;
      border: 5px solid #333;
      border-top-color: #00c851;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Checkbox customizado */
    input[type="checkbox"] {
      width: 22px;
      height: 22px;
      border: 2px solid #4a4a4a;
      background: #1a1a1a;
      border-radius: 6px;
      cursor: pointer;
      position: relative;
      transition: 0.15s;
      appearance: none;
    }

    input[type="checkbox"]:checked {
      background: #00c851;
      border-color: #00c851;
    }

    input[type="checkbox"]:checked::after {
      content: "✔";
      position: absolute;
      top: -2px;
      left: 4px;
      color: white;
      font-size: 16px;
      font-weight: bold;
    }

    select, textarea, input {
      -webkit-appearance: none;
      appearance: none;
    }
  </style>
</head>

<body>
  <div class="min-h-screen flex items-center justify-center p-6">
    <div class="card w-full max-w-2xl p-8 fade">

      <h1 class="text-3xl font-bold text-center mb-6 text-white">
        Confirmação de Presença
      </h1>

      <!-- Selecionar convidado -->
      <div class="mb-6">
        <label class="block mb-2 text-gray-300">Seu nome</label>
        <select id="guestSelect" class="input w-full p-3"></select>
      </div>

      <!-- Dependentes -->
      <div id="depsContainer" class="hidden mb-6 fade">
        <label class="block mb-2 text-gray-300">Acompanhantes</label>
        <div id="depsList" class="space-y-3"></div>
      </div>

      <!-- Mensagem -->
      <div class="mb-6 fade">
        <label class="block mb-2 text-gray-300">Mensagem (opcional)</label>
        <textarea id="mensagem" class="input w-full p-3" rows="3" placeholder="Deixe uma mensagem especial..."></textarea>
      </div>

      <!-- Botão -->
      <button id="btnConfirm" class="btn-primary w-full p-3 text-lg">
        Confirmar Presença
      </button>

      <div id="responseBox" class="text-center mt-6 text-lg font-semibold"></div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="messageModal" class="fixed inset-0 hidden items-center justify-center z-50 modal-back">
    <div class="modal-box p-6 w-80 text-center">
      <h2 id="modalTitle" class="text-xl font-bold text-white mb-3"></h2>
      <p id="modalMessage" class="text-gray-300 mb-4"></p>
      <button onclick="closeModal()" class="px-5 py-2 bg-[#00c851] text-black rounded-lg font-semibold">
        OK
      </button>
    </div>
  </div>

  <!-- LOADING -->
  <div id="loadingModal" class="fixed inset-0 hidden items-center justify-center z-50 modal-back">
    <div class="modal-box flex flex-col items-center gap-4 p-6 w-80">
      <div class="spinner"></div>
      <p class="text-white text-lg font-semibold">Carregando...</p>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz4G0dk0X2KQOqnZ_KtURaGuFstLEBeyambX15lvdhZqCE6okDoLeM-XSRkAvvZ7mTQ/exec";

    function showModal(title, message) {
      document.getElementById("modalTitle").innerText = title;
      document.getElementById("modalMessage").innerText = message;
      document.getElementById("messageModal").classList.remove("hidden");
    }

    function closeModal() {
      document.getElementById("messageModal").classList.add("hidden");
    }

    function showLoading() {
      document.getElementById("loadingModal").classList.remove("hidden");
    }

    function hideLoading() {
      document.getElementById("loadingModal").classList.add("hidden");
    }

    /* ========= CARREGAR CONVIDADOS ========= */
    async function loadGuests() {
      showLoading();

      try {
        const res = await fetch(`${API_URL}?action=getGuests`);
        const data = await res.json();

        const select = document.querySelector('#guestSelect');
        select.innerHTML = '<option value="">Selecione seu nome...</option>';

        data.guests.forEach(g => {
          const op = document.createElement('option');
          op.value = g.nome;
          op.textContent = g.nome;
          op.dataset.deps = JSON.stringify(g.dependentes);
          select.appendChild(op);
        });

      } catch {
        showModal("Erro", "Não foi possível carregar os convidados.");
      }

      hideLoading();
    }

    /* ========= AO SELECIONAR CONVIDADO ========= */
    document.querySelector('#guestSelect').addEventListener('change', (e) => {
      const deps = JSON.parse(e.target.selectedOptions[0].dataset.deps || "[]");
      const container = document.querySelector('#depsContainer');
      const list = document.querySelector('#depsList');

      list.innerHTML = "";

      if (deps.length === 0) {
        container.classList.add('hidden');
        return;
      }

      container.classList.remove('hidden');

      deps.forEach(dep => {
        const id = "dep_" + dep.replace(/\s+/g, "_");
        const label = document.createElement("label");
        label.className = "flex items-center gap-3 cursor-pointer";

        const input = document.createElement("input");
        input.type = "checkbox";
        input.id = id;
        input.value = dep;

        const span = document.createElement("span");
        span.textContent = dep;
        span.className = "text-gray-200";

        label.appendChild(input);
        label.appendChild(span);
        list.appendChild(label);
      });
    });

    /* ========= CONFIRMAR ========= */
    document.querySelector('#btnConfirm').addEventListener('click', async () => {
      const nome = document.querySelector('#guestSelect').value;
      const mensagem = document.querySelector('#mensagem').value;
      const deps = [...document.querySelectorAll('#depsList input:checked')].map(i => i.value);

      if (!nome) {
        showModal("Atenção", "Selecione seu nome.");
        return;
      }

      showLoading();

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({
            action: "submitConfirmation",
            nome,
            dependentes: deps,
            mensagem,
            ua: navigator.userAgent
          })
        });

        const data = await res.json();
        hideLoading();

        showModal(data.success ? "Sucesso" : "Erro", data.message);

      } catch {
        hideLoading();
        showModal("Erro", "Falha ao enviar confirmação.");
      }
    });

    loadGuests();
  </script>
</body>
</html>

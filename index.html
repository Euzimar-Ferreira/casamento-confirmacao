<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Confirmação de Presença</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    body {
      background: #111;
      color: #eee;
      font-family: 'Poppins', sans-serif;
    }
    .card {
      background: #1b1b1b;
      border: 1px solid #333;
      border-radius: 20px;
    }
    .input {
      background: #222 !important;
      border: 1px solid #444 !important;
      color: #eee !important;
      border-radius: 10px;
    }
    .input:focus {
      border-color: #888 !important;
    }
    .btn-primary {
      background: white;
      color: black;
      border-radius: 12px;
      font-weight: 600;
      transition: 0.3s;
    }
    .btn-primary:hover {
      background: #e5e5e5;
    }
    .fade {
      animation: fadeIn .6s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===================== */
    /* MODAIS MODERNOS      */
    /* ===================== */

    .modal-back {
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(3px);
      animation: fadeBg .3s ease forwards;
    }

    @keyframes fadeBg {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-box {
      transform: scale(0.85);
      opacity: 0;
      animation: popup .25s ease forwards;
    }

    @keyframes popup {
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Loading Spinner personalizado */
    .spinner {
      width: 65px;
      height: 65px;
      border: 5px solid #444;
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <div class="min-h-screen flex items-center justify-center p-6">
    <div class="card w-full max-w-2xl p-8 fade">

      <h1 class="text-3xl font-bold text-center mb-6 text-white">
        Confirmação de Presença
      </h1>

      <!-- Selecionar convidado -->
      <div class="mb-6">
        <label class="block mb-2 text-gray-300">Seu nome</label>
        <select id="guestSelect" class="input w-full p-3"></select>
      </div>

      <!-- Dependentes -->
      <div id="depsContainer" class="hidden mb-6 fade">
        <label class="block mb-2 text-gray-300">Acompanhantes</label>
        <div id="depsList" class="space-y-2"></div>
      </div>

      <!-- Mensagem -->
      <div class="mb-6 fade">
        <label class="block mb-2 text-gray-300">Mensagem (opcional)</label>
        <textarea id="mensagem" class="input w-full p-3" rows="3" placeholder="Deixe uma mensagem especial..."></textarea>
      </div>

      <!-- Botão -->
      <button id="btnConfirm" class="btn-primary w-full p-3 text-lg">
        Confirmar Presença
      </button>

      <div id="responseBox" class="text-center mt-6 text-lg font-semibold"></div>
    </div>
  </div>


  <!-- ============================ -->
  <!-- MODAL DE MENSAGEM (ANIMAÇÕES SUAVES + ESCURO) -->
  <!-- ============================ -->
  <div id="messageModal" class="fixed inset-0 hidden items-center justify-center z-50 modal-back">
    <div class="modal-box bg-[#1e1e1e] p-6 rounded-2xl shadow-xl w-80 text-center border border-gray-700">
      <h2 id="modalTitle" class="text-xl font-bold mb-3"></h2>
      <p id="modalMessage" class="text-gray-300 mb-4"></p>
      <button onclick="closeModal()" class="px-5 py-2 bg-white text-black rounded-lg font-semibold">
        OK
      </button>
    </div>
  </div>


  <!-- ============================ -->
  <!-- MODAL DE CARREGAMENTO (CENTRAL + SUAVE) -->
  <!-- ============================ -->
  <div id="loadingModal" class="fixed inset-0 hidden items-center justify-center z-50 modal-back">
    <div class="modal-box flex flex-col items-center gap-4 p-6 bg-[#1e1e1e] rounded-2xl shadow-xl border border-gray-700">
      <div class="spinner"></div>
      <p class="text-white text-lg font-semibold">Carregando...</p>
    </div>
  </div>




  <!-- ============================ -->
  <!-- JAVASCRIPT -->
  <!-- ============================ -->

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz4G0dk0X2KQOqnZ_KtURaGuFstLEBeyambX15lvdhZqCE6okDoLeM-XSRkAvvZ7mTQ/exec";

    /* ========= MODAIS ========= */

    function showModal(title, message) {
      document.getElementById("modalTitle").innerText = title;
      document.getElementById("modalMessage").innerText = message;

      const modal = document.getElementById("messageModal");
      modal.classList.remove("hidden");
    }

    function closeModal() {
      const modal = document.getElementById("messageModal");
      modal.classList.add("hidden");
    }

    function showLoading() {
      document.getElementById("loadingModal").classList.remove("hidden");
    }

    function hideLoading() {
      document.getElementById("loadingModal").classList.add("hidden");
    }


    /* ========= CARREGAR CONVIDADOS ========= */

    async function loadGuests() {
      showLoading();

      try {
        const res = await fetch(`${API_URL}?action=getGuests`);
        const data = await res.json();

        const select = document.querySelector('#guestSelect');
        select.innerHTML = '<option value="">Selecione seu nome...</option>';

        data.guests.forEach(g => {
          const op = document.createElement('option');
          op.value = g.nome;
          op.textContent = g.nome;
          op.dataset.deps = JSON.stringify(g.dependentes);
          select.appendChild(op);
        });

      } catch (err) {
        showModal("Erro", "Falha ao carregar convidados.");
      }

      hideLoading();
    }


    /* ========= AO SELECIONAR CONVIDADO ========= */

    document.querySelector('#guestSelect').addEventListener('change', (e) => {
      const deps = JSON.parse(e.target.selectedOptions[0].dataset.deps || "[]");
      const container = document.querySelector('#depsContainer');
      const list = document.querySelector('#depsList');

      list.innerHTML = "";

      if (deps.length === 0) {
        container.classList.add('hidden');
        return;
      }

      container.classList.remove('hidden');

      deps.forEach(dep => {
        list.innerHTML += `
          <label class="flex items-center gap-3">
            <input type="checkbox" value="${dep}" class="accent-white w-5 h-5" checked />
            <span>${dep}</span>
          </label>
        `;
      });
    });


    /* ========= CONFIRMAR PRESENÇA ========= */

    document.querySelector('#btnConfirm').addEventListener('click', async () => {
      const nome = document.querySelector('#guestSelect').value;
      const mensagem = document.querySelector('#mensagem').value;
      const deps = [...document.querySelectorAll('#depsList input:checked')].map(i => i.value);

      if (!nome) {
        showModal("Atenção", "Selecione seu nome.");
        return;
      }

      const payload = {
        action: "submitConfirmation",
        nome,
        dependentes: deps,
        mensagem,
        ua: navigator.userAgent
      };

      showLoading();

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        hideLoading();

        showModal(data.success ? "Sucesso" : "Erro", data.message);

      } catch (err) {
        hideLoading();
        showModal("Erro", "Não foi possível enviar sua confirmação.");
      }
    });

    loadGuests();
  </script>

</body>
</html>
